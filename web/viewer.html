<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slideshow Viewer</title>
<link rel="stylesheet" href="style.css">

</head>
<body>
    <div class="logo-container">
        <img src="img/logo_omnika_transparent.png" alt="Omnika Logo" class="logo">
    </div>
    <div class="viewer" id="viewer">
        <div class="slide active" id="slideContainer">
            <div>
                <h1>No slideshow loaded</h1>
                <p>Connect to controller to load a presentation</p>
            </div>
        </div>
    </div>

    <script>
        class SlideshowViewer {
            constructor() {
                this.ws = null;
                this.currentSlideshow = null;
                this.currentSlide = 0;
                this.isPlaying = false;
                this.slideTimer = null;
                this.progressTimer = null;
                this.slideDuration = 6000;
                
                this.connectWebSocket();
                this.setupKeyboardControls();
            }

            connectWebSocket() {
                try {
                    // Use current host instead of hardcoded localhost for network access
                    const wsUrl = `ws://${window.location.hostname}:50002`;
                    this.ws = new WebSocket(wsUrl);
                    
                    this.ws.onopen = () => {
                        console.log('Connected to slideshow server');
                        // No loading screen to hide, just log
                    };

                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleServerUpdate(data);
                    };

                    this.ws.onclose = () => {
                        console.log('Disconnected from server');
                        // Try to reconnect after 3 seconds
                        setTimeout(() => this.connectWebSocket(), 3000);
                    };

                } catch (error) {
                    console.error('WebSocket connection error:', error);
                }
            }

            handleServerUpdate(data) {
                if (data.current_slideshow) {
                    this.currentSlideshow = data.current_slideshow;
                    this.currentSlide = data.current_slide || 0;
                    this.isPlaying = data.playing || false;
                    
                    this.displayCurrentSlide();
                    
                    if (this.isPlaying) {
                        this.startAutoPlay();
                    } else {
                        this.stopAutoPlay();
                    }
                }
            }

            displayCurrentSlide() {
                if (!this.currentSlideshow || !this.currentSlideshow.slides) {
                    return;
                }

                const slide = this.currentSlideshow.slides[this.currentSlide];
                if (!slide) return;

                const container = document.getElementById('slideContainer');
                const viewer = document.getElementById('viewer');
                
                // Apply theme to the slide container
                container.className = 'slide active';
                const theme = this.currentSlideshow.config?.theme || 'corporate_blue';
                container.classList.add(`theme-${theme}`);

                // Handle editor slideshows with background colors
                if (this.currentSlideshow.type === 'editor' && slide.background) {
                    container.style.background = slide.background;
                    // Also apply to the entire viewer for consistency
                    viewer.style.background = slide.background;
                } else if (this.currentSlideshow.type === 'editor' && slide.bgColor) {
                    // Handle bgColor property from editor format
                    container.style.background = slide.bgColor;
                    viewer.style.background = slide.bgColor;
                } else {
                    // Reset background for non-editor slides
                    container.style.background = '';
                    viewer.style.background = '';
                }

                // Set slide content with direct HTML insertion - no wrapper styling interference
                if (slide.type === 'html' || this.currentSlideshow.type === 'editor') {
                    // For WYSIWYG editor content, insert HTML directly without any wrapper interference
                    let content = slide.html || slide.content || '';
                    
                    // If content is just plain text without HTML tags, wrap it in a paragraph
                    if (content && !content.includes('<') && content.trim() !== '') {
                        content = `<p>${content}</p>`;
                    }
                    
                    // Direct HTML insertion - no slide-content wrapper that could interfere with styling
                    container.innerHTML = content;
                    
                    // Debug log to see what content is being displayed
                    console.log('Displaying slide content:', content);
                } else {
                    // For markdown content, also insert directly
                    container.innerHTML = slide.html || '';
                }
                
                // Post-processing for images and tables only (no alignment interference)
                const tables = container.querySelectorAll('table');
                tables.forEach(table => {
                    if (!table.style.width) {
                        table.style.width = '100%';
                    }
                });
                
                const images = container.querySelectorAll('img');
                images.forEach(img => {
                    img.classList.add('slide-image');
                });

                // Get slide duration - handle both editor and markdown formats
                this.slideDuration = slide.duration || // Editor format
                                   slide.meta?.duration || // Markdown format 
                                   this.currentSlideshow.config?.defaultDuration || 
                                   6000;
                
                // Convert seconds to milliseconds for editor slides
                if (this.currentSlideshow.type === 'editor' && this.slideDuration < 1000) {
                    this.slideDuration = this.slideDuration * 1000;
                }
            }

            startAutoPlay() {
                this.stopAutoPlay(); // Clear any existing timers
                
                if (!this.currentSlideshow) return;

                // Set timer for next slide
                this.slideTimer = setTimeout(() => {
                    this.nextSlide();
                }, this.slideDuration);
            }

            stopAutoPlay() {
                if (this.slideTimer) {
                    clearTimeout(this.slideTimer);
                    this.slideTimer = null;
                }
            }

            sendCommand(command, params = {}) {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ command, params }));
                }
            }

            setupKeyboardControls() {
                document.addEventListener('keydown', (event) => {
                    switch (event.key) {
                        case 'ArrowRight':
                        case ' ':
                            this.nextSlide();
                            break;
                        case 'ArrowLeft':
                            this.previousSlide();
                            break;
                        case 'F11':
                            this.toggleFullscreen();
                            break;
                    }
                });
            }

            nextSlide() {
                if (!this.currentSlideshow) return;
                
                const nextIndex = this.currentSlide + 1;
                if (nextIndex < this.currentSlideshow.slides.length) {
                    this.sendCommand('set_slide', { slide: nextIndex });
                } else {
                    // Loop back to first slide
                    this.sendCommand('set_slide', { slide: 0 });
                }
            }

            previousSlide() {
                if (!this.currentSlideshow) return;
                
                const prevIndex = this.currentSlide - 1;
                if (prevIndex >= 0) {
                    this.sendCommand('set_slide', { slide: prevIndex });
                } else {
                    // Loop to last slide
                    const lastSlide = this.currentSlideshow.slides.length - 1;
                    this.sendCommand('set_slide', { slide: lastSlide });
                }
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }
        }
        // Start the viewer
        const viewer = new SlideshowViewer();
    </script>
</body>
</html>
